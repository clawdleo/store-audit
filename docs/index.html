<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#C41E3A">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Pregled Trgovine</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#C41E3A;--primary-dark:#9b1730;--green:#2e7d32;--green-bg:#e8f5e9;--red:#c62828;--red-bg:#ffebee;--bg:#f5f5f5;--card:#fff;--text:#1a1a1a;--muted:#666;--border:#e0e0e0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh}
.start-screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:24px;padding-top:60px;background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff}
.logo{font-size:48px;margin-bottom:12px}
.start-screen h1{font-size:24px;margin-bottom:6px}
.start-screen p{color:rgba(255,255,255,.7);margin-bottom:24px;font-size:14px}
.form-group{width:100%;max-width:320px;margin-bottom:14px;text-align:left}
.form-group label{display:block;font-size:12px;font-weight:600;margin-bottom:4px;color:rgba(255,255,255,.8)}
.form-group input{width:100%;padding:12px 14px;border:2px solid rgba(255,255,255,.2);border-radius:10px;background:rgba(255,255,255,.1);color:#fff;font-size:16px;outline:none}
.form-group input:focus{border-color:var(--primary)}
.form-group input::placeholder{color:rgba(255,255,255,.4)}
.btn-primary{background:var(--primary);color:#fff;border:none;padding:14px 40px;border-radius:25px;font-size:16px;font-weight:600;cursor:pointer;margin-top:12px}
.btn-primary:hover{background:var(--primary-dark)}
.tabs{display:flex;width:100%;max-width:320px;margin-top:24px;background:rgba(255,255,255,.1);border-radius:10px;overflow:hidden}
.tab{flex:1;padding:12px;text-align:center;font-size:13px;font-weight:600;cursor:pointer;border:none;background:transparent;color:rgba(255,255,255,.6)}
.tab.active{background:var(--primary);color:#fff}
.tab-content{width:100%;max-width:320px;margin-top:16px;max-height:300px;overflow-y:auto}
.saved-item{background:rgba(255,255,255,.1);padding:14px 16px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.saved-item:hover{background:rgba(255,255,255,.15)}
.saved-info{flex:1;cursor:pointer}
.saved-info .name{font-size:14px;font-weight:600;margin-bottom:2px}
.saved-info .meta{font-size:11px;color:rgba(255,255,255,.5)}
.saved-actions{display:flex;gap:8px}
.btn-small{padding:6px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:none}
.btn-small.load{background:#2e7d32;color:#fff}
.btn-small.delete{background:#c62828;color:#fff}
.empty-state{text-align:center;padding:30px;color:rgba(255,255,255,.4);font-size:13px}
header{background:var(--primary);color:#fff;padding:14px 16px;position:sticky;top:0;z-index:100}
header h1{font-size:16px;margin-bottom:8px}
.progress-bar{height:5px;background:rgba(255,255,255,.3);border-radius:3px;overflow:hidden;margin-bottom:4px}
.progress-fill{height:100%;background:#fff;border-radius:3px;transition:width .3s}
.progress-text{font-size:11px;opacity:.9}
main{padding:12px;padding-bottom:160px}
.section{background:var(--card);border-radius:10px;margin-bottom:10px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.08)}
.section-header{display:flex;align-items:center;justify-content:space-between;padding:14px;cursor:pointer}
.section-header:hover{background:#fafafa}
.section-header.active{background:#f5f5f5;border-bottom:1px solid var(--border)}
.section-info h2{font-size:14px;font-weight:700;margin-bottom:2px}
.section-progress{font-size:11px;color:var(--muted)}
.chevron{color:var(--muted);font-size:11px}
.section-items{padding:8px;display:none}
.section-items.open{display:block}
.item{padding:12px;border-radius:8px;margin-bottom:6px;background:#fafafa}
.item.ok{background:var(--green-bg)}
.item.issue{background:var(--red-bg)}
.item-text{font-size:13px;margin-bottom:10px;line-height:1.4}
.item-actions{display:flex;gap:6px;margin-bottom:8px}
.btn-check{width:44px;height:44px;border:2px solid var(--border);border-radius:10px;background:#fff;font-size:18px;cursor:pointer}
.btn-check.ok:hover,.btn-check.ok.active{background:var(--green);border-color:var(--green);color:#fff}
.btn-check.issue:hover,.btn-check.issue.active{background:var(--red);border-color:var(--red);color:#fff}
.btn-photo{flex:1;height:44px;border:2px dashed var(--border);border-radius:10px;background:#fff;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:4px}
.btn-photo:hover{border-color:var(--primary);color:var(--primary)}
.item-photos{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.photo-thumb{position:relative;width:60px;height:60px}
.photo-thumb img{width:100%;height:100%;object-fit:cover;border-radius:6px}
.photo-remove{position:absolute;top:-5px;right:-5px;width:20px;height:20px;border-radius:50%;background:var(--red);color:#fff;border:2px solid #fff;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.item-note{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:12px;outline:none}
.item-note:focus{border-color:var(--primary)}
footer{position:fixed;bottom:0;left:0;right:0;padding:10px 12px;background:#fff;border-top:1px solid var(--border)}
.footer-row{display:flex;gap:8px;margin-bottom:8px}
.footer-row:last-child{margin-bottom:0}
.btn-footer{flex:1;padding:12px;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer}
.btn-footer.primary{background:var(--primary);color:#fff}
.btn-footer.secondary{background:#1a1a2e;color:#fff}
.btn-footer.outline{background:#fff;color:var(--text);border:2px solid var(--border)}
.btn-footer:hover{opacity:.9}
.hidden{display:none!important}
.toast{position:fixed;bottom:180px;left:50%;transform:translateX(-50%);background:#1a1a2e;color:#fff;padding:12px 20px;border-radius:25px;font-size:13px;z-index:200;opacity:0;transition:opacity .3s;max-width:90%;text-align:center}
.toast.show{opacity:1}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:300;display:flex;align-items:center;justify-content:center;padding:20px}
.modal-content{background:#fff;border-radius:12px;padding:20px;width:100%;max-width:320px}
.modal h3{font-size:16px;margin-bottom:12px}
.modal p{font-size:13px;color:var(--muted);margin-bottom:16px}
.modal-buttons{display:flex;gap:10px}
.modal-buttons button{flex:1;padding:12px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;border:none}
.modal-buttons .cancel{background:#eee;color:var(--text)}
.modal-buttons .confirm{background:var(--primary);color:#fff}
@media(min-width:600px){main{max-width:600px;margin:0 auto}footer{max-width:600px;left:50%;transform:translateX(-50%)}}
</style>
</head>
<body>

<div id="start-screen" class="start-screen">
  <div class="logo">Pregled</div>
  <h1>Pregled Trgovine</h1>
  <p>Checklist za pregled skladnosti trgovine</p>
  
  <div class="form-group">
    <label>Ime trgovine</label>
    <input type="text" id="storeName" placeholder="npr. Ljubljana Center">
  </div>
  <div class="form-group">
    <label>Ime pregledovalca</label>
    <input type="text" id="auditorName" placeholder="Vase ime">
  </div>
  <button class="btn-primary" onclick="startNewAudit()">Zacni pregled</button>
  
  <div class="tabs">
    <button class="tab active" onclick="switchTab('audits')">Shranjeni pregledi</button>
    <button class="tab" onclick="switchTab('reports')">Izvozena porocila</button>
  </div>
  
  <div id="tab-audits" class="tab-content">
    <div id="savedAuditsList"></div>
  </div>
  
  <div id="tab-reports" class="tab-content hidden">
    <div id="savedReportsList"></div>
  </div>
</div>

<div id="app" class="hidden">
  <header>
    <h1 id="headerTitle">Pregled</h1>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <span class="progress-text" id="progressText">0/30 (0%)</span>
  </header>
  <main id="mainContent"></main>
  <footer>
    <div class="footer-row">
      <button class="btn-footer outline" onclick="backToStart()">Nazaj</button>
      <button class="btn-footer secondary" onclick="saveAudit()">Shrani</button>
    </div>
    <div class="footer-row">
      <button class="btn-footer primary" onclick="exportPDF()">Izvozi in deli PDF</button>
    </div>
  </footer>
</div>

<div id="toast" class="toast"></div>
<div id="modal" class="modal hidden"></div>

<!-- PDF Preview (hidden) -->
<div id="pdf-preview" style="display:none;position:absolute;left:-9999px;background:#fff;width:210mm;padding:15mm;font-family:Arial,sans-serif;font-size:11pt;color:#000;">
  <div style="background:#C41E3A;color:#fff;padding:20px;margin:-15mm -15mm 20px -15mm;">
    <h1 style="margin:0;font-size:20pt;" id="pdf-title">Porocilo Pregleda Trgovine</h1>
    <p style="margin:10px 0 0 0;font-size:10pt;" id="pdf-meta"></p>
  </div>
  <div id="pdf-content"></div>
  <div style="background:#1a1a2e;color:#fff;padding:15px;margin-top:20px;border-radius:5px;">
    <h3 style="margin:0 0 10px 0;">POVZETEK</h3>
    <p style="margin:0;" id="pdf-summary"></p>
  </div>
</div>

<script>
const STORAGE_KEY = 'store-audit';
const CHECKLIST = {
  "TRGOVINA": [
    "Gasilni aparati in hidranti dostopni",
    "Trgovina zasilni izhodi oznaceni, dostopni",
    "Trgovina evakuacijski nacrt",
    "Zaposleni z izpitom za platformo v razlicnih izmenah",
    "Imajo vsi zaposleni cevlje (morajo imeti obute)",
    "Vocovo zaposleni CSS (ali so vsi zaposleni notri, imajo slike, stari zaposleni izbrisani, oznaka nad tablico po konceptu)"
  ],
  "SKLADISCE": [
    "Lestve izpravne (gume v dobrem stanju, spage pritrjene)",
    "Platforma izpravna?",
    "Cisto in urejeno in vse izza rumenih crt",
    "Gasilni aparati in hidranti so dostopni",
    "Sprinklerji dostopni, brez paketov izpod njih - vsaj 1m",
    "Luci v skladiscu imajo vsaj 1m do prve skatle",
    "Koncept skladisca (preveriti oznake po oddelkih v skladiscu)",
    "Elektro omarica lepo dostopna da se da odpreti na 90 stopinj",
    "Tabla za vaso varnost posodobljena",
    "Orodje v dobrem stanju (vozicki, paletniki itd..)"
  ],
  "WC IN SKUPNI PROSTORI": [
    "Cisto in urejeno",
    "Plakati v skupnih prostorih postavljeni po konceptu (tocno po sliki - preveriti okvirje)",
    "Poster interna organizacija je pravilna (po konceptu)",
    "Preveriti prvo pomoc (da ni potekel rok)"
  ],
  "ZAPOSLENI": [
    "Ali imajo vsi zaposleni PI in PLI?",
    "MYPIPELINE (preveriti barve, area responsible enako kot na IO plakatu, Vodje izmen - kljuci, enako kot na IO plakatu)",
    "Zaposleni (uniforma, cevlji, nametag po konceptu)",
    "Zaposleni (nasmejani, customer first orientirani)",
    "Intro programi + tecaji vseh zaposlenih posebaj pa novih"
  ],
  "MED OBISKOM PAZITI NA": [
    "Atmosfera v trgovini... nasmeh, iskrice v oceh itd.",
    "Delo s strankami... pristopanje vsaki stranki",
    "Kako sodeluje interna org. v trgovinah in katere sestanke opravljamo",
    "Pregled pipeline - kaj delamo z rdecimi, kaj z zelenimi in potenciali... ali imamo talente, SMT nacrt, kaj delamo s trenutnimi potenciali itd..",
    "Status MYDEVELOPMENT - ali smo vse opravili, ali imamo izplanirano v kolikor se nismo?"
  ],
  "VIDEZ TRGOVINE": [
    "Cisto in urejeno",
    "Dobro zalozeno",
    "Cene/IDG na 100%",
    "Blagajna in vhod - cisto in urejeno",
    "Vsi morajo imeti oznako z imenom in natisnjeno ime (vsi v istem formatu, vidite koncept, da smo tu na 100%)"
  ]
};

let state = {};
let photos = {};
let notes = {};
let storeName = '';
let auditorName = '';
let currentAuditId = null;

document.addEventListener('DOMContentLoaded', function() {
  loadSavedAudits();
  loadSavedReports();
});

function showToast(msg, duration = 3000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

function showModal(title, message, onConfirm) {
  const modal = document.getElementById('modal');
  modal.innerHTML = `
    <div class="modal-content">
      <h3>${title}</h3>
      <p>${message}</p>
      <div class="modal-buttons">
        <button class="cancel" onclick="closeModal()">Preklici</button>
        <button class="confirm" onclick="closeModal();(${onConfirm})()">Potrdi</button>
      </div>
    </div>
  `;
  modal.classList.remove('hidden');
}

function closeModal() {
  document.getElementById('modal').classList.add('hidden');
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
  event.target.classList.add('active');
  document.getElementById('tab-' + tab).classList.remove('hidden');
}

function loadSavedAudits() {
  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY + '-list') || '[]');
  const container = document.getElementById('savedAuditsList');
  if (saved.length === 0) {
    container.innerHTML = '<div class="empty-state">Ni shranjenih pregledov</div>';
    return;
  }
  container.innerHTML = saved.map(a => `
    <div class="saved-item">
      <div class="saved-info" onclick="loadAudit('${a.id}')">
        <div class="name">${a.storeName}</div>
        <div class="meta">${a.date} - ${a.progress}% dokoncano</div>
      </div>
      <div class="saved-actions">
        <button class="btn-small load" onclick="loadAudit('${a.id}')">Odpri</button>
        <button class="btn-small delete" onclick="deleteAudit('${a.id}')">X</button>
      </div>
    </div>
  `).join('');
}

function loadSavedReports() {
  const reports = JSON.parse(localStorage.getItem(STORAGE_KEY + '-reports') || '[]');
  const container = document.getElementById('savedReportsList');
  if (reports.length === 0) {
    container.innerHTML = '<div class="empty-state">Ni izvozenih porocil</div>';
    return;
  }
  container.innerHTML = reports.map(r => `
    <div class="saved-item">
      <div class="saved-info">
        <div class="name">${r.storeName}</div>
        <div class="meta">${r.date} - ${r.filename}</div>
      </div>
      <div class="saved-actions">
        <button class="btn-small load" onclick="redownloadReport('${r.id}')">Deli</button>
        <button class="btn-small delete" onclick="deleteReport('${r.id}')">X</button>
      </div>
    </div>
  `).join('');
}

function startNewAudit() {
  storeName = document.getElementById('storeName').value || 'Trgovina';
  auditorName = document.getElementById('auditorName').value || 'Anonimno';
  currentAuditId = Date.now().toString();
  initChecklist();
  showApp();
}

function loadAudit(id) {
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY + '-' + id));
  if (data) {
    storeName = data.storeName;
    auditorName = data.auditorName;
    state = data.state || {};
    photos = data.photos || {};
    notes = data.notes || {};
    currentAuditId = data.id;
    document.getElementById('storeName').value = storeName;
    document.getElementById('auditorName').value = auditorName;
    showApp();
  }
}

function deleteAudit(id) {
  showModal('Izbris pregleda', 'Ali ste prepricani, da zelite izbrisati ta pregled?', function() {
    let saved = JSON.parse(localStorage.getItem(STORAGE_KEY + '-list') || '[]');
    saved = saved.filter(a => a.id !== id);
    localStorage.setItem(STORAGE_KEY + '-list', JSON.stringify(saved));
    localStorage.removeItem(STORAGE_KEY + '-' + id);
    loadSavedAudits();
    showToast('Pregled izbrisan');
  }.toString());
}

function deleteReport(id) {
  let reports = JSON.parse(localStorage.getItem(STORAGE_KEY + '-reports') || '[]');
  reports = reports.filter(r => r.id !== id);
  localStorage.setItem(STORAGE_KEY + '-reports', JSON.stringify(reports));
  localStorage.removeItem(STORAGE_KEY + '-report-' + id);
  loadSavedReports();
  showToast('Porocilo izbrisano');
}

function redownloadReport(id) {
  showToast('Odpri pregled in izvozi znova', 3000);
}

function showApp() {
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  document.getElementById('headerTitle').textContent = storeName;
  renderChecklist();
  autoSave();
}

function backToStart() {
  autoSave();
  document.getElementById('app').classList.add('hidden');
  document.getElementById('start-screen').classList.remove('hidden');
  loadSavedAudits();
  loadSavedReports();
}

function initChecklist() {
  state = {};
  photos = {};
  notes = {};
  Object.entries(CHECKLIST).forEach(([section, items]) => {
    items.forEach((_, idx) => {
      state[section + '-' + idx] = null;
    });
  });
}

function autoSave() {
  const total = Object.keys(state).length;
  const checked = Object.values(state).filter(v => v !== null).length;
  const data = {
    id: currentAuditId,
    storeName: storeName,
    auditorName: auditorName,
    state: state,
    photos: photos,
    notes: notes,
    progress: Math.round((checked / total) * 100),
    date: new Date().toLocaleDateString('sl-SI')
  };
  localStorage.setItem(STORAGE_KEY + '-' + currentAuditId, JSON.stringify(data));
}

function saveAudit() {
  autoSave();
  const current = JSON.parse(localStorage.getItem(STORAGE_KEY + '-' + currentAuditId));
  let saved = JSON.parse(localStorage.getItem(STORAGE_KEY + '-list') || '[]');
  const idx = saved.findIndex(a => a.id === current.id);
  const summary = { id: current.id, storeName: current.storeName, date: current.date, progress: current.progress };
  if (idx >= 0) saved[idx] = summary;
  else saved.unshift(summary);
  saved = saved.slice(0, 20);
  localStorage.setItem(STORAGE_KEY + '-list', JSON.stringify(saved));
  showToast('Pregled shranjen');
}

function renderChecklist() {
  let html = '';
  Object.entries(CHECKLIST).forEach(([section, items]) => {
    const checked = items.filter((_, i) => state[section + '-' + i] !== null).length;
    html += '<div class="section">';
    html += '<div class="section-header" onclick="toggleSection(this)">';
    html += '<div class="section-info"><h2>' + section + '</h2>';
    html += '<span class="section-progress">' + checked + '/' + items.length + '</span></div>';
    html += '<span class="chevron">V</span></div>';
    html += '<div class="section-items" id="sec-' + section.replace(/\s/g,'') + '">';
    items.forEach((item, idx) => { html += renderItem(section, idx, item); });
    html += '</div></div>';
  });
  document.getElementById('mainContent').innerHTML = html;
  updateProgress();
}

function renderItem(section, idx, text) {
  const key = section + '-' + idx;
  const status = state[key];
  const itemPhotos = photos[key] || [];
  const note = notes[key] || '';
  const statusClass = status === true ? 'ok' : status === false ? 'issue' : '';
  
  let html = '<div class="item ' + statusClass + '">';
  html += '<div class="item-text">' + text + '</div>';
  html += '<div class="item-actions">';
  html += '<button class="btn-check ok ' + (status===true?'active':'') + '" onclick="setStatus(\'' + key + '\',true)">OK</button>';
  html += '<button class="btn-check issue ' + (status===false?'active':'') + '" onclick="setStatus(\'' + key + '\',false)">X</button>';
  html += '<label class="btn-photo">Foto';
  if (itemPhotos.length) html += ' (' + itemPhotos.length + ')';
  html += '<input type="file" accept="image/*" capture="environment" onchange="handlePhoto(this,\'' + key + '\')" style="display:none"></label>';
  html += '</div>';
  
  if (itemPhotos.length) {
    html += '<div class="item-photos">';
    itemPhotos.forEach((p, i) => {
      html += '<div class="photo-thumb"><img src="' + p + '"><button class="photo-remove" onclick="removePhoto(\'' + key + '\',' + i + ')">x</button></div>';
    });
    html += '</div>';
  }
  
  html += '<input type="text" class="item-note" placeholder="Dodaj opombo..." value="' + note + '" onchange="setNote(\'' + key + '\',this.value)">';
  html += '</div>';
  return html;
}

function toggleSection(el) {
  const items = el.nextElementSibling;
  const isOpen = items.classList.contains('open');
  document.querySelectorAll('.section-items').forEach(s => s.classList.remove('open'));
  document.querySelectorAll('.section-header').forEach(h => {
    h.classList.remove('active');
    h.querySelector('.chevron').textContent = 'V';
  });
  if (!isOpen) {
    items.classList.add('open');
    el.classList.add('active');
    el.querySelector('.chevron').textContent = '^';
  }
}

function setStatus(key, value) {
  state[key] = value;
  autoSave();
  renderChecklist();
  reopenSection(key);
}

function setNote(key, value) {
  notes[key] = value;
  autoSave();
}

function handlePhoto(input, key) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const maxSize = 800;
      let w = img.width, h = img.height;
      if (w > maxSize || h > maxSize) {
        if (w > h) { h = h * maxSize / w; w = maxSize; }
        else { w = w * maxSize / h; h = maxSize; }
      }
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
      if (!photos[key]) photos[key] = [];
      photos[key].push(dataUrl);
      autoSave();
      renderChecklist();
      reopenSection(key);
      showToast('Foto dodana');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
  input.value = '';
}

function removePhoto(key, idx) {
  photos[key].splice(idx, 1);
  autoSave();
  renderChecklist();
  reopenSection(key);
}

function reopenSection(key) {
  const section = key.split('-')[0];
  const secEl = document.getElementById('sec-' + section.replace(/\s/g,''));
  if (secEl) {
    secEl.classList.add('open');
    secEl.previousElementSibling.classList.add('active');
    secEl.previousElementSibling.querySelector('.chevron').textContent = '^';
  }
}

function updateProgress() {
  const total = Object.keys(state).length;
  const checked = Object.values(state).filter(v => v !== null).length;
  const pct = Math.round((checked / total) * 100);
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = checked + '/' + total + ' (' + pct + '%)';
}

function downloadBase64PDF(base64Data, filename) {
  const byteCharacters = atob(base64Data);
  const byteNumbers = new Array(byteCharacters.length);
  for (let i = 0; i < byteCharacters.length; i++) {
    byteNumbers[i] = byteCharacters.charCodeAt(i);
  }
  const byteArray = new Uint8Array(byteNumbers);
  const blob = new Blob([byteArray], { type: 'application/pdf' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function exportPDF() {
  showToast('Ustvarjam PDF...');
  saveAudit();
  
  try {
    const date = new Date().toLocaleString('sl-SI');
    const dateShort = new Date().toISOString().split('T')[0];
    const filename = 'pregled-' + storeName.replace(/\s/g,'-') + '-' + dateShort + '.pdf';
    
    let ok = 0, issues = 0, unchecked = 0;
    
    // Build PDF content
    document.getElementById('pdf-title').textContent = 'Porocilo: ' + storeName;
    document.getElementById('pdf-meta').textContent = 'Pregledal: ' + auditorName + ' | Datum: ' + date;
    
    let contentHtml = '';
    for (const section of Object.keys(CHECKLIST)) {
      const items = CHECKLIST[section];
      contentHtml += '<div style="background:#f0f0f0;padding:8px 12px;margin:15px 0 10px 0;font-weight:bold;color:#C41E3A;">' + section + '</div>';
      
      for (let idx = 0; idx < items.length; idx++) {
        const key = section + '-' + idx;
        const status = state[key];
        const note = notes[key];
        const itemPhotos = photos[key] || [];
        
        let statusHtml = '<span style="color:#ef6c00;font-weight:bold;">[ ] Ni preverjeno</span>';
        if (status === true) { statusHtml = '<span style="color:#2e7d32;font-weight:bold;">[OK] V redu</span>'; ok++; }
        else if (status === false) { statusHtml = '<span style="color:#c62828;font-weight:bold;">[X] Tezava</span>'; issues++; }
        else { unchecked++; }
        
        contentHtml += '<div style="padding:8px 0;border-bottom:1px solid #eee;">';
        contentHtml += '<div>' + statusHtml + '</div>';
        contentHtml += '<div style="margin:4px 0 0 15px;">' + items[idx] + '</div>';
        if (note) {
          contentHtml += '<div style="margin:4px 0 0 15px;color:#666;font-style:italic;">Opomba: ' + note + '</div>';
        }
        if (itemPhotos.length > 0) {
          contentHtml += '<div style="margin:8px 0 0 15px;">';
          for (const p of itemPhotos) {
            contentHtml += '<img src="' + p + '" style="width:60px;height:60px;object-fit:cover;margin-right:5px;border-radius:4px;">';
          }
          contentHtml += '</div>';
        }
        contentHtml += '</div>';
      }
    }
    document.getElementById('pdf-content').innerHTML = contentHtml;
    document.getElementById('pdf-summary').textContent = 'V redu: ' + ok + '   |   Tezave: ' + issues + '   |   Ni preverjeno: ' + unchecked;
    
    // Show preview for html2pdf
    const element = document.getElementById('pdf-preview');
    element.style.display = 'block';
    element.style.position = 'fixed';
    element.style.left = '0';
    element.style.top = '0';
    
    const opt = {
      margin: 10,
      filename: filename,
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    
    await html2pdf().set(opt).from(element).save();
    
    // Hide preview
    element.style.display = 'none';
    element.style.position = 'absolute';
    element.style.left = '-9999px';
    
    // Save to reports list
    const reportId = Date.now().toString();
    let reports = JSON.parse(localStorage.getItem(STORAGE_KEY + '-reports') || '[]');
    reports.unshift({ id: reportId, storeName: storeName, date: date, filename: filename });
    reports = reports.slice(0, 20);
    localStorage.setItem(STORAGE_KEY + '-reports', JSON.stringify(reports));
    
    showToast('PDF ustvarjen: ' + filename, 4000);
    
  } catch(e) {
    console.error('PDF error:', e);
    showToast('Napaka: ' + e.message, 5000);
  }
}

</script>
</body>
</html>
