<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#C41E3A">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Pregled Trgovine</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#C41E3A;--primary-dark:#9b1730;--green:#2e7d32;--green-bg:#e8f5e9;--red:#c62828;--red-bg:#ffebee;--bg:#f5f5f5;--card:#fff;--text:#1a1a1a;--muted:#666;--border:#e0e0e0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh}
.start-screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;text-align:center;background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff}
.logo{font-size:64px;margin-bottom:16px}
.start-screen h1{font-size:28px;margin-bottom:8px}
.start-screen p{color:rgba(255,255,255,.7);margin-bottom:32px}
.form-group{width:100%;max-width:320px;margin-bottom:16px;text-align:left}
.form-group label{display:block;font-size:13px;font-weight:600;margin-bottom:6px;color:rgba(255,255,255,.8)}
.form-group input{width:100%;padding:14px 16px;border:2px solid rgba(255,255,255,.2);border-radius:12px;background:rgba(255,255,255,.1);color:#fff;font-size:16px;outline:none}
.form-group input:focus{border-color:var(--primary)}
.form-group input::placeholder{color:rgba(255,255,255,.4)}
.btn-primary{background:var(--primary);color:#fff;border:none;padding:16px 48px;border-radius:30px;font-size:17px;font-weight:600;cursor:pointer;margin-top:16px}
.btn-primary:hover{background:var(--primary-dark)}
header{background:var(--primary);color:#fff;padding:16px 20px;position:sticky;top:0;z-index:100}
header h1{font-size:18px;margin-bottom:10px}
.progress-bar{height:6px;background:rgba(255,255,255,.3);border-radius:3px;overflow:hidden;margin-bottom:6px}
.progress-fill{height:100%;background:#fff;border-radius:3px;transition:width .3s}
.progress-text{font-size:12px;opacity:.9}
main{padding:12px;padding-bottom:80px}
.section{background:var(--card);border-radius:12px;margin-bottom:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.08)}
.section-header{display:flex;align-items:center;justify-content:space-between;padding:16px;cursor:pointer}
.section-header:hover{background:#fafafa}
.section-header.active{background:#f5f5f5;border-bottom:1px solid var(--border)}
.section-info h2{font-size:15px;font-weight:700;margin-bottom:2px}
.section-progress{font-size:12px;color:var(--muted)}
.chevron{color:var(--muted);font-size:12px}
.section-items{padding:8px;display:none}
.section-items.open{display:block}
.item{padding:14px;border-radius:10px;margin-bottom:8px;background:#fafafa}
.item.ok{background:var(--green-bg)}
.item.issue{background:var(--red-bg)}
.item-text{font-size:14px;margin-bottom:12px;line-height:1.5}
.item-actions{display:flex;gap:8px;margin-bottom:10px}
.btn-check{width:48px;height:48px;border:2px solid var(--border);border-radius:12px;background:#fff;font-size:20px;cursor:pointer}
.btn-check.ok:hover,.btn-check.ok.active{background:var(--green);border-color:var(--green);color:#fff}
.btn-check.issue:hover,.btn-check.issue.active{background:var(--red);border-color:var(--red);color:#fff}
.btn-photo{flex:1;height:48px;border:2px dashed var(--border);border-radius:12px;background:#fff;font-size:14px;cursor:pointer}
.btn-photo:hover{border-color:var(--primary);color:var(--primary)}
.item-photos{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.photo-thumb{position:relative;width:72px;height:72px}
.photo-thumb img{width:100%;height:100%;object-fit:cover;border-radius:8px}
.photo-remove{position:absolute;top:-6px;right:-6px;width:22px;height:22px;border-radius:50%;background:var(--red);color:#fff;border:2px solid #fff;font-size:14px;cursor:pointer}
.item-note{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:13px;outline:none}
.item-note:focus{border-color:var(--primary)}
footer{position:fixed;bottom:0;left:0;right:0;padding:12px 16px;background:#fff;border-top:1px solid var(--border)}
.btn-export{width:100%;padding:16px;background:var(--primary);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer}
.btn-export:hover{background:var(--primary-dark)}
.hidden{display:none!important}
@media(min-width:600px){main{max-width:600px;margin:0 auto}}
</style>
</head>
<body>

<div id="start-screen" class="start-screen">
  <div class="logo">üìã</div>
  <h1>Pregled Trgovine</h1>
  <p>Checklist za pregled skladnosti trgovine</p>
  <div class="form-group">
    <label>Ime trgovine</label>
    <input type="text" id="storeName" placeholder="npr. Ljubljana Center">
  </div>
  <div class="form-group">
    <label>Ime pregledovalca</label>
    <input type="text" id="auditorName" placeholder="Va≈°e ime">
  </div>
  <button class="btn-primary" onclick="startAudit()">Zaƒçni pregled</button>
</div>

<div id="app" class="hidden">
  <header>
    <h1 id="headerTitle">üìã Pregled</h1>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <span class="progress-text" id="progressText">0/30 (0%)</span>
  </header>
  <main id="mainContent"></main>
  <footer><button class="btn-export" onclick="exportReport()">üìÑ Izvozi PDF</button></footer>
</div>

<input type="file" id="fileInput" accept="image/*" capture="environment" style="display:none">

<script>
const CHECKLIST = {
  "TRGOVINA": [
    "Gasilni aparati in hidranti dostopni",
    "Trgovina zasilni izhodi oznaƒçeni, dostopni",
    "Trgovina evakuacijski naƒçrt",
    "Zaposleni z izpitom za platformo v razliƒçnih izmenah",
    "Imajo vsi zaposleni ƒçevlje (morajo imeti obute)",
    "Vocovo zaposleni CSS (ali so vsi zaposleni notri, imajo slike, stari zaposleni izbrisani, oznaka nad tablico po konceptu)"
  ],
  "SKLADI≈†ƒåE": [
    "Lestve izpravne (gume v dobrem stanju, ≈°page pritrjene)",
    "Platforma izpravna?",
    "ƒåisto in urejeno in vse izza rumenih ƒçrt",
    "Gasilni aparati in hidranti so dostopni",
    "Sprinklerji dostopni, brez paketov izpod njih - vsaj 1m",
    "Luƒçi v skladi≈°ƒçu imajo vsaj 1m do prve ≈°katle",
    "Koncept skladi≈°ƒça (preveriti oznake po oddelkih v skladi≈°ƒçu)",
    "Elektro omarica lepo dostopna da se da odpreti na 90 stopinj",
    "Tabla za va≈°o varnost posodobljena",
    "Orodje v dobrem stanju (voziƒçki, paletniki itd..)"
  ],
  "WC IN SKUPNI PROSTORI": [
    "ƒåisto in urejeno",
    "Plakati v skupnih prostorih postavljeni po konceptu (toƒçno po sliki - preveriti okvirje)",
    "Poster interna organizacija je pravilna (po konceptu)",
    "Preveriti prvo pomoƒç (da ni potekel rok)"
  ],
  "ZAPOSLENI": [
    "Ali imajo vsi zaposleni PI in PLI?",
    "MYPIPELINE (preveriti barve, area responsible enako kot na IO plakatu, Vodje izmen - kljuƒçi, enako kot na IO plakatu)",
    "Zaposleni (uniforma, ƒçevlji, nametag po konceptu)",
    "Zaposleni (nasmejani, customer first orientirani)",
    "Intro programi + teƒçaji vseh zaposlenih posebaj pa novih"
  ],
  "MED OBISKOM PAZITI NA": [
    "Atmosfera v trgovini... nasmeh, iskrice v oƒçeh itd.",
    "Delo s strankami... pristopanje vsaki stranki",
    "Kako sodeluje interna org. v trgovinah in katere sestanke opravljamo",
    "Pregled pipeline - kaj delamo z rdeƒçimi, kaj z zelenimi in potenciali... ali imamo talente, SMT naƒçrt, kaj delamo s trenutnimi potenciali itd..",
    "Status MYDEVELOPMENT - ali smo vse opravili, ali imamo izplanirano v kolikor ≈°e nismo?"
  ],
  "VIDEZ TRGOVINE": [
    "ƒåisto in urejeno",
    "Dobro zalo≈æeno",
    "Cene/IDG na 100%",
    "Blagajna in vhod - ƒçisto in urejeno",
    "Vsi morajo imeti oznako z imenom in natisnjeno ime (vsi v istem formatu, vidite koncept, da smo tu na 100%)"
  ]
};

let state = {};
let photos = {};
let notes = {};
let storeName = '';
let auditorName = '';
let currentPhotoKey = null;

function startAudit() {
  storeName = document.getElementById('storeName').value || 'Trgovina';
  auditorName = document.getElementById('auditorName').value || 'Anonimno';
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  document.getElementById('headerTitle').textContent = 'üìã ' + storeName;
  initChecklist();
  renderChecklist();
}

function initChecklist() {
  Object.entries(CHECKLIST).forEach(([section, items]) => {
    items.forEach((_, idx) => {
      state[`${section}-${idx}`] = null;
    });
  });
}

function renderChecklist() {
  let html = '';
  Object.entries(CHECKLIST).forEach(([section, items]) => {
    const checked = items.filter((_, i) => state[`${section}-${i}`] !== null).length;
    html += `
      <div class="section">
        <div class="section-header" onclick="toggleSection(this)">
          <div class="section-info">
            <h2>${section}</h2>
            <span class="section-progress">${checked}/${items.length}</span>
          </div>
          <span class="chevron">‚ñº</span>
        </div>
        <div class="section-items" id="sec-${section.replace(/\s/g,'')}">
          ${items.map((item, idx) => renderItem(section, idx, item)).join('')}
        </div>
      </div>
    `;
  });
  document.getElementById('mainContent').innerHTML = html;
  updateProgress();
}

function renderItem(section, idx, text) {
  const key = `${section}-${idx}`;
  const status = state[key];
  const itemPhotos = photos[key] || [];
  const note = notes[key] || '';
  const statusClass = status === true ? 'ok' : status === false ? 'issue' : '';
  
  return `
    <div class="item ${statusClass}" id="item-${key.replace(/\s/g,'')}">
      <div class="item-text">${text}</div>
      <div class="item-actions">
        <button class="btn-check ok ${status===true?'active':''}" onclick="setStatus('${key}',true)">‚úì</button>
        <button class="btn-check issue ${status===false?'active':''}" onclick="setStatus('${key}',false)">‚úó</button>
        <button class="btn-photo" onclick="capturePhoto('${key}')">üì∑${itemPhotos.length?' ('+itemPhotos.length+')':''}</button>
      </div>
      ${itemPhotos.length ? `<div class="item-photos">${itemPhotos.map((p,i) => `
        <div class="photo-thumb">
          <img src="${p}" alt="">
          <button class="photo-remove" onclick="removePhoto('${key}',${i})">√ó</button>
        </div>
      `).join('')}</div>` : ''}
      <input type="text" class="item-note" placeholder="Dodaj opombo..." value="${note}" onchange="setNote('${key}',this.value)">
    </div>
  `;
}

function toggleSection(el) {
  const items = el.nextElementSibling;
  const isOpen = items.classList.contains('open');
  document.querySelectorAll('.section-items').forEach(s => s.classList.remove('open'));
  document.querySelectorAll('.section-header').forEach(h => {
    h.classList.remove('active');
    h.querySelector('.chevron').textContent = '‚ñº';
  });
  if (!isOpen) {
    items.classList.add('open');
    el.classList.add('active');
    el.querySelector('.chevron').textContent = '‚ñ≤';
  }
}

function setStatus(key, value) {
  state[key] = value;
  renderChecklist();
  // Re-open the section
  const section = key.split('-')[0];
  const secEl = document.getElementById('sec-' + section.replace(/\s/g,''));
  if (secEl) {
    secEl.classList.add('open');
    secEl.previousElementSibling.classList.add('active');
    secEl.previousElementSibling.querySelector('.chevron').textContent = '‚ñ≤';
  }
}

function setNote(key, value) {
  notes[key] = value;
}

function capturePhoto(key) {
  currentPhotoKey = key;
  document.getElementById('fileInput').click();
}

document.getElementById('fileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file && currentPhotoKey) {
    const reader = new FileReader();
    reader.onloadend = function() {
      if (!photos[currentPhotoKey]) photos[currentPhotoKey] = [];
      photos[currentPhotoKey].push(reader.result);
      renderChecklist();
      // Re-open section
      const section = currentPhotoKey.split('-')[0];
      const secEl = document.getElementById('sec-' + section.replace(/\s/g,''));
      if (secEl) {
        secEl.classList.add('open');
        secEl.previousElementSibling.classList.add('active');
      }
    };
    reader.readAsDataURL(file);
  }
  e.target.value = '';
});

function removePhoto(key, idx) {
  photos[key].splice(idx, 1);
  renderChecklist();
  const section = key.split('-')[0];
  const secEl = document.getElementById('sec-' + section.replace(/\s/g,''));
  if (secEl) {
    secEl.classList.add('open');
    secEl.previousElementSibling.classList.add('active');
  }
}

function updateProgress() {
  const total = Object.keys(state).length;
  const checked = Object.values(state).filter(v => v !== null).length;
  const pct = Math.round((checked / total) * 100);
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = `${checked}/${total} (${pct}%)`;
}

async function exportReport() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const date = new Date().toLocaleString('sl-SI');
  let y = 20;
  let ok = 0, issues = 0, unchecked = 0;
  const pageHeight = 280;
  const margin = 15;
  const lineHeight = 6;
  
  function checkPage(needed = 20) {
    if (y + needed > pageHeight) {
      doc.addPage();
      y = 20;
    }
  }
  
  function addText(text, size = 10, style = 'normal', color = [0,0,0]) {
    doc.setFontSize(size);
    doc.setFont('helvetica', style);
    doc.setTextColor(...color);
    const lines = doc.splitTextToSize(text, 180);
    lines.forEach(line => {
      checkPage(lineHeight);
      doc.text(line, margin, y);
      y += lineHeight;
    });
  }
  
  // Header
  doc.setFillColor(196, 30, 58);
  doc.rect(0, 0, 210, 35, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(20);
  doc.setFont('helvetica', 'bold');
  doc.text('Porocilo Pregleda Trgovine', margin, 15);
  doc.setFontSize(11);
  doc.setFont('helvetica', 'normal');
  doc.text(`Trgovina: ${storeName}  |  Pregledal: ${auditorName}  |  ${date}`, margin, 28);
  
  y = 45;
  
  // Sections
  for (const [section, items] of Object.entries(CHECKLIST)) {
    checkPage(20);
    doc.setFillColor(240, 240, 240);
    doc.rect(margin - 2, y - 5, 184, 10, 'F');
    doc.setTextColor(196, 30, 58);
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text(section, margin, y);
    y += 12;
    
    for (let idx = 0; idx < items.length; idx++) {
      const key = `${section}-${idx}`;
      const status = state[key];
      const note = notes[key];
      const itemPhotos = photos[key] || [];
      
      let statusTxt = '[ ] Ni preverjeno';
      let statusColor = [239, 108, 0];
      if (status === true) { statusTxt = '[OK] V redu'; statusColor = [46, 125, 50]; ok++; }
      else if (status === false) { statusTxt = '[X] Tezava'; statusColor = [198, 40, 40]; issues++; }
      else { unchecked++; }
      
      checkPage(25 + (note ? 8 : 0) + (itemPhotos.length ? 35 : 0));
      
      // Status
      doc.setTextColor(...statusColor);
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.text(statusTxt, margin, y);
      y += 5;
      
      // Item text
      doc.setTextColor(30, 30, 30);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      const itemLines = doc.splitTextToSize(items[idx], 175);
      itemLines.forEach(line => {
        doc.text(line, margin + 3, y);
        y += 5;
      });
      
      // Note
      if (note) {
        doc.setTextColor(100, 100, 100);
        doc.setFontSize(9);
        doc.setFont('helvetica', 'italic');
        doc.text('Opomba: ' + note, margin + 3, y);
        y += 6;
      }
      
      // Photos
      if (itemPhotos.length > 0) {
        let photoX = margin + 3;
        for (const photoData of itemPhotos) {
          try {
            checkPage(35);
            doc.addImage(photoData, 'JPEG', photoX, y, 30, 30);
            photoX += 35;
            if (photoX > 160) { photoX = margin + 3; y += 35; }
          } catch(e) { console.log('Photo error:', e); }
        }
        y += 35;
      }
      
      y += 3;
    }
    y += 5;
  }
  
  // Summary
  checkPage(40);
  y += 5;
  doc.setFillColor(26, 26, 46);
  doc.rect(margin - 2, y - 5, 184, 30, 'F');
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.text('POVZETEK', margin + 5, y + 3);
  doc.setFontSize(11);
  doc.text(`V redu: ${ok}     Tezave: ${issues}     Ni preverjeno: ${unchecked}`, margin + 5, y + 15);
  
  // Save
  doc.save(`pregled-${storeName.replace(/\s/g,'-')}-${new Date().toISOString().split('T')[0]}.pdf`);
}
</script>
</body>
</html>
